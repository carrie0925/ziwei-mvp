# ziweicore.py

from datetime import datetime
from lunar_python import Lunar

# ================= 基本表 =================

YIN_YANG = ["陽", "陰"]
HEAVENLY_STEMS = ["甲","乙","丙","丁","戊","己","庚","辛","壬","癸"]
SHENGXIAO = ["鼠", "牛", "虎", "兔", "龍", "蛇","馬", "羊", "猴", "雞", "狗", "豬"]
EARTHLY_BRANCHES = ["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"]

PALACE_NAMES = [
    "命宮","父母宮","福德宮","田宅宮",
    "官祿宮","交友宮","遷移宮","疾厄宮",
    "財帛宮","子女宮","夫妻宮","兄弟宮","身"
]

FIVE_ELEMENTS = ["水二局","火六局","土五局","木三局","金四局"]
DASHIAN_BASE = [2, 6, 5, 3, 4]  # 先留著，之後要算大限可用

# 主星 / 六吉 / 四化 / 六煞 / 其他
STAR_M_A14 = ["紫微","天機","太陽","武曲","天同","廉貞","天府",
              "太陰","貪狼","巨門","天相","天梁","七殺","破軍"]
STAR_M_A07 = ["文昌","文曲","左輔","右弼","天魁","天鉞","祿存"]
STAR_M_S04 = ["化祿","化權","化科","化忌"]
STAR_M_B06 = ["擎羊","陀羅","火星","鈴星","天空","地劫"]
STAR_O_S05 = ["天馬","龍池","鳳閣","紅鸞","天喜"]

# 五行局起紫微表 & 五行局用表
FIVE_ELE_TABLE = [
    [1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,0,0,1,1,2,2,3,3,4],
    [9,6,11,4,1,2,10,7,0,5,2,3,11,8,1,6,3,4,0,9,2,7,4,5,1,10,3,8,5,6],
    [6,11,4,1,2,7,0,5,2,3,8,1,6,3,4,9,2,7,4,5,10,3,8,5,6,11,4,9,6,7],
    [4,1,2,5,2,3,6,3,4,7,4,5,8,5,6,9,6,7,10,7,8,11,8,9,0,9,10,1,10,11],
    [11,4,1,2,0,5,2,3,1,6,3,4,2,7,4,5,3,8,5,6,4,9,6,7,5,10,7,8,6,11],
]

FIVE_ELE_ARR = [
    [0,1,3,2,4,1],
    [1,2,4,3,0,2],
    [2,3,0,4,1,3],
    [3,4,1,0,2,4],
    [4,0,2,1,3,0],
]

# 14 主星（這個 JS 裡其實沒用到，但先保留）
STAR_A14 = [
    [[0],[],[13],[],[5,6],[7],[8],[4,9],[3,10],[2,11],[12],[1]],
    [[1],[0,13],[],[6],[7],[5,8],[9],[10],[4,11],[3,12],[2],[]],
    [[13],[1],[0,6],[7],[8],[9],[5,10],[11],[12],[10],[3],[2]],
    [[2],[6],[1,7],[0,8],[9],[10],[11],[5,12],[],[],[4],[3,13]],
    [[3,6],[2,7],[8],[1,9],[0,10],[11],[12],[],[5],[],[13],[4]],
    [[4,7],[3,8],[2,9],[10],[1,10],[0,12],[],[],[],[5,13],[],[6]],
    [[8],[4,9],[3,10],[2,11],[12],[1],[0],[],[13],[],[5,6],[7]],
    [[9],[10],[4,11],[3,12],[2],[],[1],[0,13],[],[6],[7],[5,8]],
    [[5,10],[11],[12],[10],[3],[2],[13],[1],[0,6],[7],[8],[9]],
    [[11],[5,12],[],[],[4],[3,13],[2],[6],[1,7],[0,8],[9],[10]],
    [[12],[],[5],[],[13],[4],[3,6],[2,7],[8],[1,9],[0,10],[11]],
    [[],[],[],[5,13],[],[6],[4,7],[3,8],[2,9],[10],[1,10],[0,12]],
]

# 紫微星系 + 天府系位置表
STAR_Z06 = [
    [0,1,2,3,4,5,6,7,8,9,10,11],
    [11,0,1,2,3,4,5,6,7,8,9,10],
    [9,10,11,0,1,2,3,4,5,6,7,8],
    [8,9,10,11,0,1,2,3,4,5,6,7],
    [7,8,9,10,11,0,1,2,3,4,5,6],
    [4,5,6,7,8,9,10,11,0,1,2,3],
    [4,3,2,1,0,11,10,9,8,7,6,5],
]

STAR_T08 = [
    [0,1,2,3,4,5,6,7,8,9,10,11],
    [1,2,3,4,5,6,7,8,9,10,11,0],
    [2,3,4,5,6,7,8,9,10,11,0,1],
    [3,4,5,6,7,8,9,10,11,0,1,2],
    [4,5,6,7,8,9,10,11,0,1,2,3],
    [5,6,7,8,9,10,11,0,1,2,3,4],
    [6,7,8,9,10,11,0,1,2,3,4,5],
    [10,11,0,1,2,3,4,5,6,7,8,9],
]

STAR_G07 = [
    [10,9,8,7,6,5,4,3,2,1,0,11],
    [4,5,6,7,8,9,10,11,0,1,2,3],
    [4,5,6,7,8,9,10,11,0,1,2,3],
    [10,9,8,7,6,5,4,3,2,1,0,11],
    [1,0,11,11,1,0,1,6,3,3],
    [7,8,9,9,7,8,7,2,5,5],
    [2,3,5,6,5,6,8,9,11,0],
]

STAR_S04 = [
    [STAR_M_A14[5],STAR_M_A14[1],STAR_M_A14[4],STAR_M_A14[7],STAR_M_A14[8],STAR_M_A14[3],STAR_M_A14[2],STAR_M_A14[9],STAR_M_A14[11],STAR_M_A14[13]],
    [STAR_M_A14[13],STAR_M_A14[11],STAR_M_A14[1],STAR_M_A14[4],STAR_M_A14[7],STAR_M_A14[8],STAR_M_A14[3],STAR_M_A14[2],STAR_M_A14[0],STAR_M_A14[9]],
    [STAR_M_A14[3],STAR_M_A14[0],STAR_M_A07[0],STAR_M_A14[1],STAR_M_A07[3],STAR_M_A14[11],STAR_M_A14[7],STAR_M_A07[1],STAR_M_A07[2],STAR_M_A14[7]],
    [STAR_M_A14[2],STAR_M_A14[7],STAR_M_A14[5],STAR_M_A14[9],STAR_M_A14[1],STAR_M_A07[1],STAR_M_A14[4],STAR_M_A07[0],STAR_M_A14[3],STAR_M_A14[8]],
]

STAR_B06 = [
    [3,4,6,7,6,7,9,10,0,1],
    [1,2,4,5,4,5,7,8,10,11],
    [
        [2,3,4,5,6,7,8,9,10,11,0,1],
        [3,4,5,6,7,8,9,10,11,0,1,2],
        [1,2,3,4,5,6,7,8,9,10,11,0],
        [9,10,11,0,1,2,3,4,5,6,7,8],
    ],
    [
        [10,11,0,1,2,3,4,5,6,7,8,9],
        [10,11,0,1,2,3,4,5,6,7,8,9],
        [3,4,5,6,7,8,9,10,11,0,1,2],
        [10,11,0,1,2,3,4,5,6,7,8,9],
    ],
    [11,10,9,8,7,6,5,4,3,2,1,0],
    [11,0,1,2,3,4,5,6,7,8,9,10],
]

STAR_OS5 = [
    [2,11,8,5,2,11,8,5,2,11,8,5],
    [4,5,6,7,8,9,10,11,0,1,2,3],
    [10,9,8,7,6,5,4,3,2,1,0,11],
    [3,2,1,0,11,10,9,8,7,6,5,4],
    [9,8,7,6,5,4,3,2,1,0,11,10],
]


# ================= 工具函式 =================

def solar_hour_to_branch_index(hour: int) -> int:
    """
    將 0–23 點換成地支 index（子、丑、寅...）
    23:00–00:59 => 子
    01:00–02:59 => 丑
    ...
    """
    return ((hour + 1) // 2) % 12


def get_s04_suffix(star_name: str, sS04: list[str]) -> str:
    """看此星是否四化，如果有就回傳『化祿 / 化權 / 化科 / 化忌』"""
    try:
        idx = sS04.index(star_name)
        return STAR_M_S04[idx]
    except ValueError:
        return ""


# ================= 主函式：計算紫微命盤 =================

def calculate_ziwei_chart(dt: datetime, gender: str):
    """
    依照你提供的 JavaScript 版本完整翻成 Python，
    回傳格式：
    {
      "子": {
          "宮位": 0,              # 0~11，按子丑寅...
          "宮名": "交友宮",        # 命宮 / 兄弟宮...
          "主星": ["廉貞", "天相化科"...],
          "六吉": [...],          # 文昌、文曲、左輔、右弼、魁鉞、祿存
          "凶星": [...],          # 擎羊、陀羅、火鈴、空劫
          "雜曜": [...],          # 天馬、紅鸞、天喜...
          "命宮": True/False,
          "身宮": True/False,
          "五行局": "火六局" or None,
      },
      ...
    }
    """
    # 1. 西元年 → 年干支
    year = dt.year
    year_stem_index = (year - 4) % 10  # 甲 0 ~ 癸 9
    year_branch_index = (year - 4) % 12

    y1Pos = year_stem_index
    y2Pos = year_branch_index

    # 2. 西元 → 農曆
    lunar = Lunar.fromDate(dt)
    lunar_month = lunar.getMonth()
    # lunar_python 閏月會是負數，JS 只用 m 1~12，不管閏
    if lunar_month < 0:
        lunar_month = -lunar_month
    lunar_day = lunar.getDay()

    # 3. 時辰地支 index
    hPos = solar_hour_to_branch_index(dt.hour)

    # ========== setZiwei(d) 的部分 ==========

    # 命宮位置 (lPos)
    lPos = ( (12 - hPos) + 1 + lunar_month ) % 12

    # 身宮位置 (bPos)
    bPos = ( 12 - ((22 - hPos) + 1 - lunar_month) % 12 ) % 12

    # 五行局
    idx_in_six = ((lPos - (0 if lPos % 2 == 0 else 1)) // 2) % 6
    five_ele_idx = FIVE_ELE_ARR[y1Pos % 5][idx_in_six]
    five_ele_str = FIVE_ELEMENTS[five_ele_idx]

    # 紫微所在宮 zPos
    five_row = FIVE_ELEMENTS.index(five_ele_str)
    zPos = FIVE_ELE_TABLE[five_row][lunar_day - 1]

    # ========== stepSetStar(y,m,d,h) 的部分 ==========

    # 紫微星系 6 顆 + 天府系 8 顆的基礎座標
    sZ06 = [STAR_Z06[r][zPos] for r in range(7)]
    tianfu_pos = sZ06[6]
    sT08 = [STAR_T08[r][tianfu_pos] for r in range(8)]

    # 六吉星位置
    pos_arr = [hPos, hPos, lunar_month - 1, lunar_month - 1,
               y1Pos, y1Pos, y1Pos]
    sG07 = [STAR_G07[i][pos_arr[i]] for i in range(7)]

    # 四化星指定對象
    sS04 = [STAR_S04[i][y1Pos] for i in range(4)]

    # 六煞星
    sB06 = [
        STAR_B06[0][y1Pos],
        STAR_B06[1][y1Pos],
        STAR_B06[2][y2Pos % 4][hPos],
        STAR_B06[3][y2Pos % 4][hPos],
        STAR_B06[4][hPos],
        STAR_B06[5][hPos],
    ]

    # 其他雜曜
    OS05 = [STAR_OS5[i][y2Pos] for i in range(5)]

    # ========== 組 Place12 / chart 結構 ==========

    chart: dict[str, dict] = {}

    for i in range(12):
        starA: list[str] = []
        starB: list[str] = []
        starC: list[str] = []
        star6: list[str] = []

        # 紫微系 & 六煞
        for k in range(6):
            if sZ06[k] == i:
                name = STAR_M_A14[k]
                suffix = get_s04_suffix(name, sS04)
                if suffix:
                    name = f"{name}{suffix}"
                starA.append(name)

            if sB06[k] == i:
                starB.append(STAR_M_B06[k])

        # 天府系（後 8 顆主星）
        for k in range(8):
            if sT08[k] == i:
                idx = k + 6
                name = STAR_M_A14[idx]
                suffix = get_s04_suffix(name, sS04)
                if suffix:
                    name = f"{name}{suffix}"
                starA.append(name)

        # 六吉星
        for k in range(7):
            if sG07[k] == i:
                name = STAR_M_A07[k]
                suffix = get_s04_suffix(name, sS04)
                if suffix:
                    name = f"{name}{suffix}"
                star6.append(name)

        # 其他雜曜
        for k in range(5):
            if OS05[k] == i:
                starC.append(STAR_O_S05[k])

        # 宮名：根據命宮位置旋轉
        palace_str = PALACE_NAMES[(12 - lPos + i) % 12]
        branch = EARTHLY_BRANCHES[i]

        chart[branch] = {
            "宮位": i,
            "宮名": palace_str,
            "主星": starA,        # 14 主星 + 化祿權科忌標記
            "六吉": star6,        # 文昌、文曲、左輔、右弼、魁鉞、祿存 (+ 化科等)
            "凶星": starB,        # 擎羊、陀羅、火鈴、空劫
            "雜曜": starC,        # 天馬、紅鸞、天喜...
            "命宮": (i == lPos),
            "身宮": (i == bPos),
            "五行局": five_ele_str if i == lPos else None,
        }

    return chart
